# âš™ï¸ LUMEN: Carotid Calculator Engine â€” Phase 1B (Calculator + Logic Engine)

A high-performance backend engine built to compute ICA/CCA ratios, classify
carotid stenosis, and interpret vertebral flow â€” all dynamically, based on 
structured templates and site-specific rules.

---

## ğŸ§¬ 1. Template Definition (Your Clinical DNA)


## 1. Template Layer
exam_templates/carotid.json
â”œâ”€ Defines segment structure and field names
â””â”€ Includes site-specific thresholds and waveform rules

## 2. Template Loader
template_registry.get_template(exam_type, site)
â”œâ”€ Loads carotid.json for the specified site/version

## 3. Exam Factory
exam_factory.create_exam_from_template()
â”œâ”€ Creates Exam object
â”œâ”€ Creates Segment objects for each JSON block
â””â”€ Initializes Measurement objects with blank values

## 4. Site Criteria Loader
site_loader.load_carotid_criteria(site)
â”œâ”€ Loads stenosis thresholds and vertebral flow rules
â”œâ”€ Normalizes site path to /site/<site>/criteria/carotid.json
â””â”€ Used by CarotidCalculator for site-specific logic

## 5. Calculator Engine
CarotidCalculator(segments, criteria)
â”œâ”€ .run_all()
â”‚ â”œâ”€ compute_ica_cca_ratio()
â”‚ â”œâ”€ apply_stenosis_logic()
â”‚ â””â”€ interpret_vertebral_waveform()
â”œâ”€ Injects into:
â”‚ â”œâ”€ segment["ica_cca_ratio"]
â”‚ â”œâ”€ segment["stenosis_category"]
â”‚ â””â”€ segment["vertebral_comment"]
â”œâ”€ Utility:
â”‚ â”œâ”€ get_segment_data()
â”‚ â”œâ”€ export_json()
â”‚ â””â”€ log_all_segments()

## 6. Calculator Utilities
base_calculator.py
â”œâ”€ resolve_value_from_segment()
â”œâ”€ evaluate_expression_with_variables()
â””â”€ calculate_from_segment()

## 7. Segment Typing
base_arterial_segments.py
â”œâ”€ ArterialSegmentBase (TypedDict with psv, edv, etc.)

carotid_segments.py
â”œâ”€ CarotidSegmentDict (extends ArterialSegmentBase)
â”‚ â”œâ”€ Adds cca_psv, ica_cca_ratio, stenosis_category, vertebral_comment

## 8. Output
Each segment dict holds calculated fields
â”œâ”€ Passed to frontend via API
â”œâ”€ Displayed in PDF and HL7 ORU payloads
â””â”€ Editable via ReportConclusion





1. Template Layer
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ exam_templates/carotid.json   â”‚ â—€â”€ Defines segment structure + field names
â”‚                               â”‚     and site-specific thresholds
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼

2. Template Loader
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ template_registry.get_template()       â”‚ â—€â”€ Loads carotid.json per site/version
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼

3. Exam Factory
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ exam_factory.create_exam_from_template()      â”‚
â”‚  â”œâ”€ Creates Exam                              â”‚
â”‚  â”œâ”€ Creates Segment objects (per JSON block)  â”‚
â”‚  â””â”€ Initializes Measurement fields to null    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼

4. Site Criteria Loader
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ site_loader.load_carotid_criteria(site)        â”‚ â—€â”€ Loads siteâ€™s carotid.json thresholds
â”‚  â”œâ”€ stenosis_thresholds                        â”‚
â”‚  â””â”€ vertebral_rules                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼

5. Calculator Engine
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CarotidCalculator(segments, criteria)            â”‚
â”‚                                                  â”‚
â”‚ .run_all() â†’ Applies:                            â”‚
â”‚   â”œâ”€ compute_ica_cca_ratio()                     â”‚
â”‚   â”œâ”€ apply_stenosis_logic()                      â”‚
â”‚   â””â”€ interpret_vertebral_waveform()              â”‚
â”‚                                                  â”‚
â”‚ Stores results in:                               â”‚
â”‚   â”œâ”€ segment["ica_cca_ratio"]                    â”‚
â”‚   â”œâ”€ segment["stenosis_category"]                â”‚
â”‚   â””â”€ segment["vertebral_comment"]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”˜
                             â”‚
                             â–¼

6. Segment Utilities
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ base_calculator.py                                 â”‚
â”‚  â”œâ”€ resolve_value_from_segment()                   â”‚
â”‚  â”œâ”€ evaluate_expression_with_variables()           â”‚
â”‚  â””â”€ calculate_from_segment()                       â”‚
â”‚ Used by calculator for all math + conversions      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

7. Segment Typing
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ base_arterial_segments.py                  â”‚
â”‚  â””â”€ ArterialSegmentBase (TypedDict)        â”‚
â”‚                                            â”‚
â”‚ carotid_segments.py                        â”‚
â”‚  â””â”€ CarotidSegmentDict (extends base)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

8. Output
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ segment dicts contain all derived values     â”‚
â”‚ Exported via:                                â”‚
â”‚  â”œâ”€ .get_segment_data()                      â”‚
â”‚  â”œâ”€ .export_json()                           â”‚
â”‚  â””â”€ .log_all_segments()                      â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
